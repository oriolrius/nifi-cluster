#!/bin/bash
# NiFi Cluster Management Tool
# Unified interface for managing NiFi clusters

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/cluster-utils.sh"

# Show usage
show_usage() {
    cat << EOF
${BLUE}╔════════════════════════════════════════════════════════════════╗${NC}
${BLUE}║  NiFi Cluster Management Tool                                 ║${NC}
${BLUE}╚════════════════════════════════════════════════════════════════╝${NC}

Usage: $0 <command> [cluster_name] [options]

Commands:
  create <cluster> [nodes]  Create a new cluster (default: 3 nodes)
  list              List all available clusters
  info <cluster>    Show detailed cluster information
  status [cluster]  Show cluster and node status (all clusters if not specified)
  start <cluster>   Start a cluster
  stop <cluster>    Stop a cluster
  restart <cluster> Restart a cluster
  logs <cluster>    Follow logs for cluster (all nodes)
  wait <cluster>    Wait for cluster to be ready
  validate <cluster> Validate cluster configuration

Options:
  -h, --help       Show this help message

Examples:
  $0 create cluster01        # Create cluster01 with 3 nodes (default)
  $0 create production05 5   # Create production05 with 5 nodes
  $0 list                    # List all clusters
  $0 info cluster01          # Show cluster01 details
  $0 status                  # Check all clusters
  $0 status cluster01        # Check specific cluster
  $0 start cluster01         # Start cluster01
  $0 stop cluster02          # Stop cluster02
  $0 logs cluster01          # Follow logs for cluster01
  $0 wait cluster01          # Wait for cluster01 to be ready
  $0 validate cluster01      # Validate cluster01 configuration

EOF
}

# Create a new cluster
cmd_create() {
    local cluster_name="$1"
    local node_count="${2:-3}"  # Default to 3 nodes

    if [ -z "$cluster_name" ]; then
        echo -e "${RED}Error: Cluster name required${NC}"
        echo "Usage: $0 create <cluster_name> [node_count]"
        echo ""
        echo "Examples:"
        echo "  $0 create cluster01        # Creates cluster01 with 3 nodes"
        echo "  $0 create production05 5   # Creates production05 with 5 nodes"
        return 1
    fi

    # Validate cluster name pattern: [a-zA-Z]+[0-9]{2}
    if ! [[ "$cluster_name" =~ ^[a-zA-Z]+[0-9]{2}$ ]]; then
        echo -e "${RED}Error: Invalid cluster name pattern${NC}"
        echo "Cluster name must match pattern: [text][two-digits]"
        echo ""
        echo "Valid examples:"
        echo "  - cluster01, cluster02, ..., cluster10"
        echo "  - production01, production05, production10"
        echo "  - test01, staging02, dev03"
        echo ""
        echo "Invalid examples:"
        echo "  - cluster1 (only one digit)"
        echo "  - cluster011 (three digits)"
        echo "  - cluster_01 (contains underscore)"
        echo "  - 01cluster (starts with digits)"
        return 1
    fi

    # Extract cluster number from last 2 digits
    local cluster_num="${cluster_name: -2}"
    # Remove leading zero if present (01 -> 1, 05 -> 5, 10 -> 10)
    cluster_num=$((10#$cluster_num))

    # Validate cluster number is between 1 and 10
    if [ "$cluster_num" -lt 1 ] || [ "$cluster_num" -gt 10 ]; then
        echo -e "${RED}Error: Cluster number must be between 01 and 10${NC}"
        echo "Extracted cluster number: ${cluster_num}"
        echo ""
        echo "Valid examples:"
        echo "  - cluster01 (cluster #1)"
        echo "  - cluster05 (cluster #5)"
        echo "  - cluster10 (cluster #10)"
        echo ""
        echo "Invalid examples:"
        echo "  - cluster00 (cluster #0, must be >= 1)"
        echo "  - cluster11 (cluster #11, must be <= 10)"
        return 1
    fi

    # Validate node count
    if ! [[ "$node_count" =~ ^[0-9]+$ ]] || [ "$node_count" -lt 1 ]; then
        echo -e "${RED}Error: Node count must be a positive integer${NC}"
        return 1
    fi

    # Check if cluster already exists
    if cluster_exists "$cluster_name"; then
        echo -e "${RED}Error: Cluster ${cluster_name} already exists${NC}"
        echo ""
        echo "To recreate the cluster:"
        echo "  1. Stop and remove the existing cluster:"
        echo "     $0 stop ${cluster_name}"
        echo "     docker compose -f docker-compose-${cluster_name}.yml down -v"
        echo "     rm -rf clusters/${cluster_name}"
        echo "     rm docker-compose-${cluster_name}.yml"
        echo "  2. Run create command again"
        return 1
    fi

    echo -e "${BLUE}Creating cluster ${cluster_name}...${NC}"
    echo "  Cluster Number: ${cluster_num}"
    echo "  Node Count:     ${node_count}"
    echo ""

    # Call the create-cluster.sh script
    "${SCRIPT_DIR}/lib/create-cluster.sh" "$cluster_name" "$cluster_num" "$node_count"
}

# List all clusters
cmd_list() {
    local clusters=($(get_all_clusters))

    if [ ${#clusters[@]} -eq 0 ]; then
        echo -e "${YELLOW}No clusters found.${NC}"
        echo ""
        echo "Create a cluster with:"
        echo "  $0 create cluster01"
        return 0
    fi

    echo -e "${BLUE}Available Clusters:${NC}"
    echo ""

    for cluster in "${clusters[@]}"; do
        local status=$(get_cluster_status "$cluster")
        local node_count=$(get_node_count "$cluster")
        local cluster_num=$(get_cluster_num "$cluster")
        local base_port=$(get_base_port "$cluster_num")

        local status_icon
        local status_color
        case "$status" in
            "running")
                status_icon="●"
                status_color="${GREEN}"
                ;;
            "stopped")
                status_icon="○"
                status_color="${YELLOW}"
                ;;
            *)
                status_icon="✗"
                status_color="${RED}"
                ;;
        esac

        printf "  ${status_color}${status_icon}${NC} %-12s  %d nodes  Port: %d  Status: %s\n" \
            "$cluster" "$node_count" "$base_port" "$status"
    done
}

# Show cluster info
cmd_info() {
    local cluster_name="$1"

    if [ -z "$cluster_name" ]; then
        echo -e "${RED}Error: Cluster name required${NC}"
        echo "Usage: $0 info <cluster_name>"
        return 1
    fi

    if ! validate_cluster_name "$cluster_name"; then
        return 1
    fi

    if ! cluster_exists "$cluster_name"; then
        echo -e "${RED}Error: Cluster ${cluster_name} not found${NC}"
        return 1
    fi

    echo -e "${BLUE}╔════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║  Cluster Information: ${cluster_name}${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    print_cluster_info "$cluster_name"

    local node_count=$(get_node_count "$cluster_name")
    echo ""
    echo -e "${BLUE}Nodes:${NC}"
    for i in $(seq 1 "$node_count"); do
        local url=$(get_cluster_url "$cluster_name" "$i")
        local container="${cluster_name}.nifi-${i}"
        local running=$(docker ps --filter "name=${container}" --format '{{.Names}}' | wc -l)

        if [ "$running" -gt 0 ]; then
            echo -e "  ${GREEN}●${NC} Node ${i}: ${url}/nifi (${container})"
        else
            echo -e "  ${YELLOW}○${NC} Node ${i}: ${url}/nifi (${container})"
        fi
    done

    echo ""
    echo -e "${BLUE}Management Commands:${NC}"
    echo "  Start:   docker compose -f docker-compose-${cluster_name}.yml up -d"
    echo "  Stop:    docker compose -f docker-compose-${cluster_name}.yml down"
    echo "  Logs:    docker compose -f docker-compose-${cluster_name}.yml logs -f"
    echo "  Status:  docker compose -f docker-compose-${cluster_name}.yml ps"
}

# Start cluster
cmd_start() {
    local cluster_name="$1"

    if [ -z "$cluster_name" ]; then
        echo -e "${RED}Error: Cluster name required${NC}"
        return 1
    fi

    if ! cluster_exists "$cluster_name"; then
        echo -e "${RED}Error: Cluster ${cluster_name} not found${NC}"
        return 1
    fi

    echo -e "${BLUE}Starting cluster ${cluster_name}...${NC}"
    docker compose -f "docker-compose-${cluster_name}.yml" up -d

    echo ""
    echo -e "${GREEN}✓ Cluster start command issued${NC}"
    echo ""
    echo "Wait for cluster to be ready:"
    echo "  $0 wait ${cluster_name}"
}

# Stop cluster
cmd_stop() {
    local cluster_name="$1"

    if [ -z "$cluster_name" ]; then
        echo -e "${RED}Error: Cluster name required${NC}"
        return 1
    fi

    if ! cluster_exists "$cluster_name"; then
        echo -e "${RED}Error: Cluster ${cluster_name} not found${NC}"
        return 1
    fi

    echo -e "${BLUE}Stopping cluster ${cluster_name}...${NC}"
    docker compose -f "docker-compose-${cluster_name}.yml" down

    echo -e "${GREEN}✓ Cluster stopped${NC}"
}

# Restart cluster
cmd_restart() {
    local cluster_name="$1"

    if [ -z "$cluster_name" ]; then
        echo -e "${RED}Error: Cluster name required${NC}"
        return 1
    fi

    cmd_stop "$cluster_name" && cmd_start "$cluster_name"
}

# Show cluster logs
cmd_logs() {
    local cluster_name="$1"

    if [ -z "$cluster_name" ]; then
        echo -e "${RED}Error: Cluster name required${NC}"
        return 1
    fi

    if ! cluster_exists "$cluster_name"; then
        echo -e "${RED}Error: Cluster ${cluster_name} not found${NC}"
        return 1
    fi

    echo -e "${BLUE}Following logs for cluster ${cluster_name}...${NC}"
    echo "Press Ctrl+C to stop"
    echo ""
    docker compose -f "docker-compose-${cluster_name}.yml" logs -f
}

# Wait for cluster
cmd_wait() {
    local cluster_name="$1"
    local timeout="${2:-180}"

    if [ -z "$cluster_name" ]; then
        echo -e "${RED}Error: Cluster name required${NC}"
        return 1
    fi

    wait_for_cluster "$cluster_name" "$timeout"
}

# Validate cluster configuration
cmd_validate() {
    local cluster_name="$1"

    if [ -z "$cluster_name" ]; then
        echo -e "${RED}Error: Cluster name required${NC}"
        return 1
    fi

    echo -e "${BLUE}Validating cluster ${cluster_name}...${NC}"
    echo ""

    local errors=0

    # Check docker-compose file
    if ! cluster_exists "$cluster_name"; then
        echo -e "${RED}✗ Docker compose file not found${NC}"
        errors=$((errors + 1))
    else
        echo -e "${GREEN}✓ Docker compose file exists${NC}"
    fi

    # Check configuration directories
    local cluster_num=$(get_cluster_num "$cluster_name")
    local node_count=$(get_node_count "$cluster_name")

    for i in $(seq 1 "$node_count"); do
        local conf_dir="clusters/${cluster_name}/conf/${cluster_name}.nifi-${i}"
        if [ -d "$conf_dir" ]; then
            # Check required files
            if [ -f "$conf_dir/nifi.properties" ]; then
                echo -e "${GREEN}✓ Node ${i} nifi.properties exists${NC}"
            else
                echo -e "${RED}✗ Node ${i} nifi.properties missing${NC}"
                errors=$((errors + 1))
            fi

            if [ -f "$conf_dir/keystore.p12" ] && [ -f "$conf_dir/truststore.p12" ]; then
                echo -e "${GREEN}✓ Node ${i} certificates exist${NC}"
            else
                echo -e "${RED}✗ Node ${i} certificates missing${NC}"
                errors=$((errors + 1))
            fi
        else
            echo -e "${RED}✗ Node ${i} configuration directory missing${NC}"
            errors=$((errors + 1))
        fi
    done

    echo ""
    if [ $errors -eq 0 ]; then
        echo -e "${GREEN}✓ Validation passed${NC}"
        return 0
    else
        echo -e "${RED}✗ Validation failed with ${errors} error(s)${NC}"
        return 1
    fi
}

# Main command dispatcher
main() {
    if [ $# -eq 0 ]; then
        show_usage
        exit 0
    fi

    local command="$1"
    shift

    case "$command" in
        create)
            cmd_create "$@"
            ;;
        list)
            cmd_list
            ;;
        info)
            cmd_info "$@"
            ;;
        status)
            # Use the check-cluster.sh script
            "${SCRIPT_DIR}/lib/check-cluster.sh" "$@"
            ;;
        start)
            cmd_start "$@"
            ;;
        stop)
            cmd_stop "$@"
            ;;
        restart)
            cmd_restart "$@"
            ;;
        logs)
            cmd_logs "$@"
            ;;
        wait)
            cmd_wait "$@"
            ;;
        validate)
            cmd_validate "$@"
            ;;
        -h|--help|help)
            show_usage
            ;;
        *)
            echo -e "${RED}Error: Unknown command '${command}'${NC}"
            echo ""
            show_usage
            exit 1
            ;;
    esac
}

main "$@"
